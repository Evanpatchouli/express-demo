<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>全局变量与配置文件 - 跟着例子学Express.js</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">模块化学习</li><li class="chapter-item expanded "><a href="../chapter_1/intro.html"><strong aria-hidden="true">1.</strong> 本章简介</a></li><li class="chapter-item expanded "><a href="../chapter_1/HelloWorld.html"><strong aria-hidden="true">2.</strong> HelloWorld</a></li><li class="chapter-item expanded "><a href="../chapter_1/请求类型.html"><strong aria-hidden="true">3.</strong> 请求类型</a></li><li class="chapter-item expanded "><a href="../chapter_1/处理请求数据.html"><strong aria-hidden="true">4.</strong> 处理请求数据</a></li><li class="chapter-item expanded "><a href="../chapter_1/响应.html"><strong aria-hidden="true">5.</strong> 响应</a></li><li class="chapter-item expanded "><a href="../chapter_1/knex增删改查.html"><strong aria-hidden="true">6.</strong> Sql-knex增删改查</a></li><li class="chapter-item expanded "><a href="../chapter_1/ORM增删改查.html"><strong aria-hidden="true">7.</strong> Sql-ORM增删改查</a></li><li class="chapter-item expanded "><a href="../chapter_1/路由控制.html"><strong aria-hidden="true">8.</strong> 路由控制</a></li><li class="chapter-item expanded "><a href="../chapter_1/JWT基础鉴权.html"><strong aria-hidden="true">9.</strong> JWT基础鉴权</a></li><li class="chapter-item expanded "><a href="../chapter_1/全局错误处理.html"><strong aria-hidden="true">10.</strong> 全局错误处理</a></li><li class="chapter-item expanded "><a href="../chapter_1/中间件.html"><strong aria-hidden="true">11.</strong> 中间件</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">架构整合</li><li class="chapter-item expanded "><a href="../chapter_2/intro.html"><strong aria-hidden="true">12.</strong> 本章简介</a></li><li class="chapter-item expanded "><a href="../chapter_2/express-cli.html"><strong aria-hidden="true">13.</strong> express-cli</a></li><li class="chapter-item expanded "><a href="../chapter_2/MVC层级架构.html"><strong aria-hidden="true">14.</strong> MVC层级架构</a></li><li class="chapter-item expanded "><a href="../chapter_2/分布式架构.html"><strong aria-hidden="true">15.</strong> 分布式架构</a></li><li class="chapter-item expanded "><a href="../chapter_2/微服务架构.html"><strong aria-hidden="true">16.</strong> 微服务架构</a></li><li class="chapter-item expanded "><a href="../chapter_2/evp-express-cli.html"><strong aria-hidden="true">17.</strong> evp-express-cli</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">高级进阶</li><li class="chapter-item expanded "><a href="../chapter_3/intro.html"><strong aria-hidden="true">18.</strong> 本章简介</a></li><li class="chapter-item expanded "><a href="../chapter_3/全局变量与配置文件.html" class="active"><strong aria-hidden="true">19.</strong> 全局变量与配置文件</a></li><li class="chapter-item expanded "><a href="../chapter_3/数据库初始化.html"><strong aria-hidden="true">20.</strong> 数据库初始化</a></li><li class="chapter-item expanded "><a href="../chapter_3/express-validator.html"><strong aria-hidden="true">21.</strong> express-validator</a></li><li class="chapter-item expanded "><a href="../chapter_3/集成redis.html"><strong aria-hidden="true">22.</strong> 集成redis</a></li><li class="chapter-item expanded "><a href="../chapter_3/集成rabbitmq.html"><strong aria-hidden="true">23.</strong> 集成rabbitmq</a></li><li class="chapter-item expanded "><a href="../chapter_3/集成websocket.html"><strong aria-hidden="true">24.</strong> 集成websocket</a></li><li class="chapter-item expanded "><a href="../chapter_3/集成SocketIO.html"><strong aria-hidden="true">25.</strong> 集成SocketIO</a></li><li class="chapter-item expanded "><a href="../chapter_3/全面鉴权.html"><strong aria-hidden="true">26.</strong> 全面鉴权</a></li><li class="chapter-item expanded "><a href="../chapter_3/软件测试.html"><strong aria-hidden="true">27.</strong> 软件测试</a></li><li class="chapter-item expanded "><a href="../chapter_3/软件构建.html"><strong aria-hidden="true">28.</strong> 软件构建</a></li><li class="chapter-item expanded "><a href="../chapter_3/Docker部署.html"><strong aria-hidden="true">29.</strong> Docker部署</a></li><li class="chapter-item expanded "><a href="../chapter_3/pm2进程管理.html"><strong aria-hidden="true">30.</strong> pm2进程管理</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../后记.html">后记</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">跟着例子学Express.js</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="全局变量与配置文件"><a class="header" href="#全局变量与配置文件">全局变量与配置文件</a></h1>
<p>通常我们会将一些项目的配置信息写在一个文件内，然后读入内存并使用。在 express 中使用全局变量有多种方案，我们一起看看有哪些常用的方案</p>
<h2 id="准备工作"><a class="header" href="#准备工作">准备工作</a></h2>
<p>拷贝第一节的HelloWorld项目</p>
<p>准备一个Resp.js模块：</p>
<pre><code class="language-js">module.exports = {
    Ok: (...args)=&gt;{
        return {
            code: 200,
            msg: args[0]?args[0]:&quot;Ok&quot;,
            data: args[1]?args[1]:null
        }
    }
}
</code></pre>
<h2 id="global"><a class="header" href="#global">global</a></h2>
<p>在<strong>global</strong>对象中挂载我们需要全局共享的量，比如我们想要挂载一个全局的config作为整个express应用的配置，就在项目的唯一入口文件（如: index.js, app.js等）的最顶上（优先于任何模块）设置一次：</p>
<pre><code class="language-js">// index.js
global.config = {
    appname: &quot;GlobalVar&quot;
}
/** 更简洁的写法，隐变量，首次被执行到后，会自动挂载到全局
config = {
    appname: &quot;GlobalVar&quot;
}
*/
//创建app应用...
</code></pre>
<p>这样我们就可以在其它任何地方调用config，比如新建一个router.js挂载到express应用上去</p>
<pre><code class="language-js">// router.js
const routes = require('express').Router();
routes.get('/global', (req, res, next)=&gt;{
    res.send(Resp.Ok(&quot;global中的全局变量&quot;, {&quot;appname&quot;:config.appname}));
});

module.exports = routes;

// index.js
app.use(routes);
</code></pre>
<p>如果我们有很多需要全局共享的配置，挤在index.js的上方多少有点不雅观，那我们可以把它们写在一个文件里，然后在index.js最顶上引入一下</p>
<pre><code class="language-js">// global.js
global.config = {
    appname: &quot;GlobalVar&quot;
}

// index.js
require('./global');
</code></pre>
<p>**注意：**由于global中的变量是可以直接以变量名<code>xxx</code>调用的，无需<code>global.xxx</code>，如果变量名设置的比较普通，就比如上面的<code>config</code>，甚至更简单的<code>a</code>之类的，很可能跟其它模块中定义的临时变量冲突，造成变量污染，因此在global上挂载变量时取名一定要特殊点，比如：之前的<code>config</code>替换为<code>__config</code></p>
<pre><code class="language-js">global.__config = {
    appname: &quot;GlobalVar&quot;
}
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>调用很便捷</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>可能变量污染</li>
<li>没有代码提示，不心安</li>
</ul>
<h2 id="module"><a class="header" href="#module">module</a></h2>
<p>自定义一个module，存放一些变量，在需要的地方进行引入<br />
比如：我们自建一个config.js</p>
<pre><code class="language-js">// config.js
module.exports = {
    appname: &quot;GlobalVar&quot;
}
</code></pre>
<p>在router.js中引入config.js</p>
<pre><code class="language-js">// router.js
const CONFIG = require('./config');

routes.get('/module', (req, res, next)=&gt;{
    res.send(Resp.Ok(&quot;config模块当作全局变量&quot;, {&quot;appname&quot;:CONFIG.appname}));
});
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>能有代码提示</li>
<li>无变量污染</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>每次都要引入，比较麻烦</li>
</ul>
<h2 id="appset"><a class="header" href="#appset">app.set</a></h2>
<p>在 express 的应用设置表中设置应用内的全局变量：</p>
<pre><code class="language-js">// index.js
app.set(&quot;appname&quot;, &quot;GlobalVar&quot;);
</code></pre>
<p>在其它地方调用app，如挂载在app上的router：</p>
<pre><code class="language-js">// router.js
routes.get('/app', (req, res, next)=&gt;{
    res.send(Resp.Ok(&quot;app中的'全局'变量&quot;, {&quot;appname&quot;:req.app.get(&quot;appname&quot;)}));
});
</code></pre>
<p>在挂载在app下的子应用中，调用父app中的设置，当某字段在子应用中没有设置时，会继承父应用中的字段</p>
<pre><code class="language-js">//subapp.js
const app = require('express')();
const Resp = require('./Resp');
//当子应用没有设置时，会继承父应用中设置的字段
// app.set('appname', &quot;subapp&quot;);
app.all('/', (req, res, next) =&gt; {
    res.send(Resp.Ok(&quot;子应用获取父应用中的全局变量&quot;, {
        appname: req.app.get(&quot;appname&quot;)
    }));
})

module.exports = app;

//index.js
const subapp = require('./subapp');
app.use('/subapp',subapp);
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>能有代码提示</li>
</ul>
<h2 id="processenv"><a class="header" href="#processenv">process.env</a></h2>
<p>在进程的环境变量中挂载全局变量：</p>
<pre><code class="language-js">//index.js
process.env.appname = &quot;GlobalVar&quot;;
</code></pre>
<p>在其它地方调用<code>process.env.appname</code>：</p>
<pre><code class="language-js">// subapp2.js
const app = require('express')();
const Resp = require('./Resp');

app.all('/', (req, res, next) =&gt; {
    // console.log(app.settings.env);
    res.send(Resp.Ok(&quot;在process.env上挂载全局变量&quot;, {
        appname: process.env.appname
    }));
})

module.exports = app;

//index.js
const subapp2 = require('./subapp2');
app.use('/process.env',subapp2);
</code></pre>
<p><strong>缺点：</strong></p>
<ul>
<li>没有代码提示，不心安</li>
</ul>
<h2 id="json"><a class="header" href="#json">json</a></h2>
<p>以上的方案都是将配置信息写在js文件中的，对于一个正规的项目来说多少有点儿戏，毕竟写在js中的变量是很容易就能被改变的。绝大多数时候，配置信息是需要变化也不允许变化的，我们只需要静态的信息即可。在Js项目中，经常用json文件作为静态配置文件。</p>
<p>新建一个<strong>config.json</strong>文件：</p>
<pre><code class="language-json">{
	&quot;appname&quot;: &quot;GlobalVar&quot;
}
</code></pre>
<p>在我们的router中新加一条测试一下，不管你在哪里require，在首次被require之后，修改json文件内容将不会再产生影响</p>
<pre><code class="language-JS">routes.get('/json', (req, res, next)=&gt;{
    let configJson = require('./config.json');
    res.send(Resp.Ok(&quot;json静态配置文件&quot;, {&quot;appname&quot;:configJson.appname}));
});
</code></pre>
<p>json文件不支持注释，如果想要注释，要么曲线救国(加与被备注键相关的键值对)，要么使用<strong>Json5</strong>规范</p>
<pre><code class="language-shell">npm install json5
</code></pre>
<p>新建一个<strong>config.json5</strong>文件：</p>
<pre><code class="language-json5">{
    &quot;appname&quot;: &quot;GlobalVar&quot;  //应用名
}
</code></pre>
<p>接着在项目的入口文件中引入register，会挂载到全局：</p>
<pre><code class="language-js">require('json5/lib/register');
</code></pre>
<p>之后require就可以解析<code>json5</code>文件了：</p>
<pre><code class="language-js">routes.get('/json5', (req, res, next)=&gt;{
    let configJson5 = require('./config.json5');
    res.send(Resp.Ok(&quot;json5静态配置文件&quot;, {&quot;appname&quot;:configJson5.appname}));
});
</code></pre>
<h2 id="yaml"><a class="header" href="#yaml">yaml</a></h2>
<p>相比<code>.json</code>文件，<code>.yaml</code>(或<code>.yml</code>)文件是更加现在的配置文件，json文件有着严格的格式要求，yaml(yml)书写起来则更加自然<br />
新建一个<strong>config.yaml</strong>文件：</p>
<pre><code class="language-yaml"># 应用名
appname: GlobalVar  # 应用名
</code></pre>
<p>在nodeJs中读取yaml需要借助<strong>fs</strong>和<strong>js-yaml</strong>：</p>
<pre><code class="language-shell">npm install fs
npm install js-yaml
</code></pre>
<p>把fs挂载到全局即可(之前的global.js)，一般情况下也不会取fs这样的局部变量名，如果需要频繁的操作文件，挂载到全局后会方便很多：</p>
<pre><code class="language-js">global.fs = require('fs');
</code></pre>
<p>在router.js中引入<code>js-yaml</code>并新建一个测试路由：</p>
<pre><code class="language-js">const yaml = require('js-yaml');

routes.get('/yaml', (req, res, next)=&gt;{
    /*Object */
    let configYaml = yaml.load(fs.readFileSync('./config.yaml'));
    res.send(Resp.Ok(&quot;yaml动态配置文件&quot;, {&quot;appname&quot;:configYaml.appname}));
});
</code></pre>
<p>由于是通过fs读取yaml文件的，因此在改变yaml文件中的内容后，访问路由的结果也会变</p>
<hr />
<p>本文总共介绍了6种方案，在项目具体采用哪种并没有绝对的说法，因地制宜即可。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../chapter_3/intro.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../chapter_3/数据库初始化.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../chapter_3/intro.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../chapter_3/数据库初始化.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
